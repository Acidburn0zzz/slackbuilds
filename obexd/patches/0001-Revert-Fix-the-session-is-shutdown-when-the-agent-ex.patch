From ca6fc415788f3a2d4d8ff4c97f297eebf1f668ed Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Wed, 14 Apr 2010 14:54:25 +0100
Subject: [PATCH] Revert "Fix: the session is shutdown when the agent exits the bus"

This reverts commit d57bffe46b71e17a640c11b389dd6da95f933729.
---
 client/session.c |   36 +++++++++++++++---------------------
 1 files changed, 15 insertions(+), 21 deletions(-)

diff --git a/client/session.c b/client/session.c
index 817f950..3876136 100644
--- a/client/session.c
+++ b/client/session.c
@@ -588,6 +588,21 @@ static void abort_transfer(struct session_data *session)
 	session_unref(session);
 }
 
+int session_set_agent(struct session_data *session, const char *name,
+							const char *path)
+{
+	if (session == NULL)
+		return -EINVAL;
+
+	if (session->agent_name != NULL || session->agent_path != NULL)
+		return -EALREADY;
+
+	session->agent_name = g_strdup(name);
+	session->agent_path = g_strdup(path);
+
+	return 0;
+}
+
 static void append_entry(DBusMessageIter *dict,
 				const char *key, int type, void *val)
 {
@@ -1857,24 +1872,3 @@ int session_put(struct session_data *session, char *buf, const char *targetname)
 
 	return 0;
 }
-
-int session_set_agent(struct session_data *session, const char *name,
-							const char *path)
-{
-	if (session == NULL)
-		return -EINVAL;
-
-	if (session->agent_name != NULL || session->agent_path != NULL)
-		return -EALREADY;
-
-	session->agent_name = g_strdup(name);
-	session->agent_path = g_strdup(path);
-
-	session->owner_watch = g_dbus_add_disconnect_watch(session->conn,
-					session->owner, owner_disconnected,
-								session, NULL);
-
-	session_ref(session);
-
-	return 0;
-}
-- 
1.7.0.1

