#!/bin/sh

# This script prepares configuration and run mpd as user

exec="/usr/bin/mpd"
conffile="/etc/mpd.conf"

[ -x ${exec} ] || exit 1

unset MPD_USER
[ -e /etc/default/mpd ] && . /etc/default/mpd
MPD_USER=${MPD_USER:-mpd:mpd}

[ -f ${conffile} ] || exit 1

checkconfig() {
  if [[ "${MPD_USER}" == "" ]] ; then
    MPD_USER="mpd"
  fi
  if ! $(getent passwd | cut -d ':' -f 1 | grep $( echo "${MPD_USER}" | cut -d ':' -f 1 ) -sq) ; then
    echo "Please edit /etc/default/mpd"
    echo "Your user has to exist!"
    return 1
  fi
  unset MPD_OUSER
  MPD_OUSER=$(echo ${MPD_USER} | cut -d ':' -f 1)
  if [[ "${MPD_OUSER}" == "root" ]] ; then
    echo "Please edit /etc/default/mpd"
    echo "Do not use root as user!"
    return 2
  fi
  unset MPD_GROUP
  echo "${MPD_USER}" | grep ':' -sq && MPD_GROUP=$( echo ${MPD_USER} | cut -d ':' -f 2 )
  if [ -n "${MPD_GROUP}" ] && ! $(cut -d ':' -f 1 /etc/group | grep "${MPD_GROUP}" -sq) ; then
    echo "Please edit /etc/default/mpd"
    echo "Your group has to exist too!"
    return 3
  fi
  MPD_USER_HOME=$(getent passwd | grep ^$( echo "${MPD_USER}" | cut -d ':' -f 1 ): | cut -d ':' -f 6)
  if [[ "${MPD_OUSER}" != "mpd" ]] ; then
    MPD_USER_CONFIG="${MPD_USER_HOME}/.mpd"
    conffile="${MPD_USER_HOME}/.mpdconf"
    if [[ ! -e "${conffile}" ]] ; then
      sed \
        -e 's|/var/lib/mpd|~/.mpd|g' \
        -e "s|^user.*\"mpd\"|user \"${MPD_OUSER}\"|g" \
        -e 's|^#pid_file|pid_file|g' \
        /etc/mpd.conf > "${conffile}" || return 4
      chown "${MPD_USER}" "${conffile}"
      mkdir -p "${MPD_USER_CONFIG}"
      chown "${MPD_USER}" "${MPD_USER_CONFIG}"
      for file in mpdstate mpd.db mpd.error mpd.log ;do
        touch "${MPD_USER_CONFIG}/${file}" || return 5
        chown "${MPD_USER}" "${MPD_USER_CONFIG}/${file}" || return 6
      done
      for dir in music playlists ;do
        mkdir -p "${MPD_USER_CONFIG}/${dir}" || return 7
        chown "${MPD_USER}" "${MPD_USER_CONFIG}/${dir}" || return 6
      done
    fi
  fi
}

checkconfig || exit $?

exec ${exec} "${conffile}" "$@"
