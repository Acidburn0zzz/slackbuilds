#!/bin/bash -e

transform="s,x,x,"

prefix=/usr
exec_prefix=${prefix}
if [ -d /lib64/grub ] ;then
  libdir=/lib64
else
  libdir=/lib
fi
grub_prefix=`echo /boot/grub | sed ${transform}`

. ${libdir}/grub/grub-mkconfig_lib

# this allows desktop-base to override our settings
f=/etc/default/grub-gfx
if test -e ${f} ; then
  source ${f}
else
  GRUB_FONT="/usr/share/grub/unicode.pf2"
  GRUB_WALLPAPER="/usr/share/grub/slk-grub-default.png"
  GRUB_COLOR_NORMAL="light-blue/black"
  GRUB_COLOR_HIGHLIGHT="light-cyan/blue"
fi

set_slk_theme()
{
  cat << EOF
set menu_color_normal=light-blue/black
set menu_color_highlight=light-cyan/blue
EOF
}

# check for usable backgrounds
use_bg=false
if [ "$GRUB_TERMINAL_OUTPUT" = "gfxterm" ] ; then
  if [ -w /boot ] && [ -w /boot/grub ] ;then
    if [ ! -f "/boot/grub/`basename ${GRUB_WALLPAPER}`" ] ;then
      [ -L "/boot/grub/`basename ${GRUB_WALLPAPER}`" ] && rm -f /boot/grub/`basename ${GRUB_WALLPAPER}`
      [ -f "${GRUB_WALLPAPER}" ] && cp -fL "${GRUB_WALLPAPER}" /boot/grub/`basename ${GRUB_WALLPAPER}`
    fi

    if [ ! -f "/boot/grub/`basename ${GRUB_FONT}`" ] ;then
      [ -f "${GRUB_FONT}" ] && cp -fL "${GRUB_FONT}" /boot/grub/`basename ${GRUB_FONT}`
    fi
  fi

  for i in /boot/grub/`basename ${GRUB_WALLPAPER}` ${GRUB_WALLPAPER} ; do
    if is_path_readable_by_grub $i ; then 
      bg=$i
      case ${bg} in
        *.png)		reader=png ;;
        *.tga)		reader=tga ;;
        *.jpg|*.jpeg)	reader=jpeg ;;
      esac
      if test -e /boot/grub/${reader}.mod ; then
        echo "Found _SLKDIST_ background: `basename ${bg}`" >&2
        use_bg=true
        break
      fi
    fi
  done
fi

# set the background if possible
if ${use_bg} ; then
  prepare_grub_to_access_device `${grub_probe} --target=device ${bg}`
  cat << EOF
insmod ${reader}
if background_image `make_system_path_relative_to_its_root ${bg}` ; then
  set color_normal=${GRUB_COLOR_NORMAL}
  set color_highlight=${GRUB_COLOR_HIGHLIGHT}
else
EOF
fi

# otherwise, set the traditional Debian blue theme
if ${use_bg} ; then
  set_slk_theme | sed -e "s/^/  /g"
  echo "fi"
else
  set_slk_theme
fi
