From b07f30a829efc3dbd32b80214a48cbcdf0790e4a Mon Sep 17 00:00:00 2001
From: mancha <mancha1 AT zoho DOT com>
Date: Mon, 14 Apr 2014
Subject: Use-after-free (CVE-2010-5298)

A use-after-free race condition in OpenSSL's read buffer, under certain
circumstances, may permit an attacker to inject data from one connection
into another.

References:

https://rt.openssl.org/Ticket/Display.html?id=2167&user=guest&pass=guest
https://rt.openssl.org/Ticket/Display.html?id=3265&user=guest&pass=guest
http://ftp.openbsd.org/pub/OpenBSD/patches/5.5/common/004_openssl.patch.sig

---

 ssl/s3_pkt.c |    3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

--- a/ssl/s3_pkt.c
+++ b/ssl/s3_pkt.c
@@ -1055,7 +1055,8 @@ start:
 				{
 				s->rstate=SSL_ST_READ_HEADER;
 				rr->off=0;
-				if (s->mode & SSL_MODE_RELEASE_BUFFERS)
+				if ((s->mode & SSL_MODE_RELEASE_BUFFERS) &&
+				    (s->s3->rbuf.left == 0))	
 					ssl3_release_read_buffer(s);
 				}
 			}
