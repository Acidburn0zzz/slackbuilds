From d5495a116c6271c0ae8f6955b64b7b010b1b341a Mon Sep 17 00:00:00 2001
From: Ulrich Drepper <drepper@gmail.com>
Date: Fri, 24 Jun 2011 14:59:17 -0400
Subject: [PATCH] Work around limit in writev in 2.6.38+ kernels

---
 ChangeLog                        |    7 +++++++
 NEWS                             |    2 +-
 sysdeps/unix/sysv/linux/Makefile |    1 +
 sysdeps/wordsize-64/tst-writev.c |   10 ++++++++--
 4 files changed, 17 insertions(+), 3 deletions(-)

diff --git a/sysdeps/unix/sysv/linux/Makefile b/sysdeps/unix/sysv/linux/Makefile
index 05834e3..ebb3f5d 100644
--- a/sysdeps/unix/sysv/linux/Makefile
+++ b/sysdeps/unix/sysv/linux/Makefile
@@ -22,6 +22,7 @@ sysdep_routines += sysctl clone llseek umount umount2 readahead \
 		   eventfd eventfd_read eventfd_write prlimit
 
 CFLAGS-gethostid.c = -fexceptions
+CFLAGS-tst-writev.c += -DARTIFICIAL_LIMIT=0x7ffff000
 
 sysdep_headers += sys/mount.h sys/acct.h sys/sysctl.h \
 		  sys/klog.h sys/kdaemon.h \
diff --git a/sysdeps/wordsize-64/tst-writev.c b/sysdeps/wordsize-64/tst-writev.c
index 6e47886..015ad46 100644
--- a/sysdeps/wordsize-64/tst-writev.c
+++ b/sysdeps/wordsize-64/tst-writev.c
@@ -96,8 +96,14 @@ do_test (void)
 
   if (ret != (ssize_t) EXPECTED)
     {
-      printf ("writev() return value: %zd != EXPECTED: %zd\n", ret, EXPECTED);
-      return 1;
+#ifdef ARTIFICIAL_LIMIT
+      if (ret != (ssize_t) ARTIFICIAL_LIMIT)
+#endif
+	{
+	  printf ("writev() return value: %zd != EXPECTED: %zd\n",
+		  ret, EXPECTED);
+	  return 1;
+	}
     }
 
   return 0;
-- 
1.7.6

