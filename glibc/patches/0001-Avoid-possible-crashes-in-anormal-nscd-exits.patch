From f6244abb8c68c705b8f8bfb3c8adb44dffe5a157 Mon Sep 17 00:00:00 2001
From: Ulrich Drepper <drepper@gmail.com>
Date: Tue, 19 Jul 2011 13:59:57 -0400
Subject: [PATCH] Avoid possible crashes in anormal nscd exits (cherry picked
 from commit feb1eb0be78b40d53c71474f07d1b0517ba95586)

---
 ChangeLog   |    5 +++++
 nscd/nscd.c |    2 +-
 2 files changed, 6 insertions(+), 1 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 22f63b1..d774296 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,8 @@
+2011-07-19  Ulrich Drepper  <drepper@gmail.com>
+
+	* nscd/nscd.c (termination_handler): Don't do anything for a database
+	if it has not yet been initialized.
+
 2011-07-05  Andreas Jaeger  <aj@suse.de>
 
 	[BZ#9696]
diff --git a/nscd/nscd.c b/nscd/nscd.c
index c3d9fe6..f50e814 100644
--- a/nscd/nscd.c
+++ b/nscd/nscd.c
@@ -477,7 +477,7 @@ termination_handler (int signum)
   /* Synchronize memory.  */
   for (int cnt = 0; cnt < lastdb; ++cnt)
     {
-      if (!dbs[cnt].enabled)
+      if (!dbs[cnt].enabled || dbs[cnt].head == NULL)
 	continue;
 
       /* Make sure nobody keeps using the database.  */
-- 
1.7.6

