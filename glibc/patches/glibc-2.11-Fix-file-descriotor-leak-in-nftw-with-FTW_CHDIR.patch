From 46f37c4fe427b3c38552d16d7d9c18be815a8c46 Mon Sep 17 00:00:00 2001
From: Ulrich Drepper <drepper@redhat.com>
Date: Wed, 10 Feb 2010 20:31:48 -0800
Subject: [PATCH 8/8] Fix file descriotor leak in nftw with FTW_CHDIR

(adjusted cherry-pick from 247fdf2e2b798378d8aeaac1ee6f4ba0a49f31f3)
---
 ChangeLog |    6 ++++++
 io/ftw.c  |    3 ++-
 2 files changed, 8 insertions(+), 1 deletions(-)

diff --git a/ChangeLog b/ChangeLog
index 41ce41e..93a9684 100644
--- a/ChangeLog
+++ b/ChangeLog
@@ -1,3 +1,9 @@
+2010-02-10  Ulrich Drepper  <drepper@redhat.com>
+
+	[BZ #11271]
+	* io/ftw.c (ftw_startup): Close	descriptor for initial directory
+	after changing back to it.
+
 2010-02-03  Ulrich Drepper  <drepper@redhat.com>
 
 	[BZ #11235]
diff --git a/io/ftw.c b/io/ftw.c
index 9cc0907..bb7dba8 100644
--- a/io/ftw.c
+++ b/io/ftw.c
@@ -1,5 +1,5 @@
 /* File tree walker functions.
-   Copyright (C) 1996-2004, 2006, 2007, 2008 Free Software Foundation, Inc.
+   Copyright (C) 1996-2004, 2006-2008, 2010 Free Software Foundation, Inc.
    This file is part of the GNU C Library.
    Contributed by Ulrich Drepper <drepper@cygnus.com>, 1996.
 
@@ -790,6 +790,7 @@ ftw_startup (const char *dir, int is_nftw, void *func, int descriptors,
     {
       int save_err = errno;
       __fchdir (cwdfd);
+      close_not_cancel_no_status (cwdfd);
       __set_errno (save_err);
     }
   else if (cwd != NULL)
-- 
1.7.0

