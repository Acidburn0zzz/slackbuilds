From 31885cd5e38ec9807a6a7ab32660cf8c2fcf48f7 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Zbigniew=20J=C4=99drzejewski-Szmek?= <zbyszek@in.waw.pl>
Date: Wed, 17 Apr 2013 17:19:38 -0400
Subject: [PATCH 2/3] core/killall: use procfs_file_alloca

---
 src/core/killall.c |  9 ++-------
 src/shared/util.c  |  9 ---------
 src/shared/util.h  | 10 ++++++++++
 3 files changed, 12 insertions(+), 16 deletions(-)

diff --git a/src/core/killall.c b/src/core/killall.c
index e078012..a0f5745 100644
--- a/src/core/killall.c
+++ b/src/core/killall.c
@@ -32,8 +32,7 @@
 #define TIMEOUT_USEC (10 * USEC_PER_SEC)
 
 static bool ignore_proc(pid_t pid) {
-        char buf[PATH_MAX];
-        FILE *f;
+        _cleanup_fclose_ FILE *f = NULL;
         char c;
         size_t count;
         uid_t uid;
@@ -51,15 +50,11 @@ static bool ignore_proc(pid_t pid) {
         if (uid != 0)
                 return false;
 
-        snprintf(buf, sizeof(buf), "/proc/%lu/cmdline", (unsigned long) pid);
-        char_array_0(buf);
-
-        f = fopen(buf, "re");
+        f = fopen(procfs_file_alloca(pid, "cmdline"), "re");
         if (!f)
                 return true; /* not really, but has the desired effect */
 
         count = fread(&c, 1, 1, f);
-        fclose(f);
 
         /* Kernel threads have an empty cmdline */
         if (count <= 0)
diff --git a/src/shared/util.c b/src/shared/util.c
index 1fc6c5a..a6ec79a 100644
--- a/src/shared/util.c
+++ b/src/shared/util.c
@@ -80,15 +80,6 @@ char **saved_argv = NULL;
 static volatile unsigned cached_columns = 0;
 static volatile unsigned cached_lines = 0;
 
-#define procfs_file_alloca(pid, field)                                  \
-        ({                                                              \
-                pid_t _pid_ = (pid);                                    \
-                char *_r_;                                              \
-                _r_ = alloca(sizeof("/proc/") -1 + DECIMAL_STR_MAX(pid_t) + 1 + sizeof(field)); \
-                sprintf(_r_, "/proc/%lu/" field, (unsigned long) _pid_); \
-                _r_;                                                    \
-        })
-
 size_t page_size(void) {
         static __thread size_t pgsz = 0;
         long r;
diff --git a/src/shared/util.h b/src/shared/util.h
index cfb5493..6575f56 100644
--- a/src/shared/util.h
+++ b/src/shared/util.h
@@ -21,6 +21,7 @@
   along with systemd; If not, see <http://www.gnu.org/licenses/>.
 ***/
 
+#include <alloca.h>
 #include <inttypes.h>
 #include <time.h>
 #include <sys/time.h>
@@ -696,3 +697,12 @@ int unlink_noerrno(const char *path);
                 strcpy(stpcpy(_c_, _a_), _b_);          \
                 _c_;                                    \
         })
+
+#define procfs_file_alloca(pid, field)                                  \
+        ({                                                              \
+                pid_t _pid_ = (pid);                                    \
+                char *_r_;                                              \
+                _r_ = alloca(sizeof("/proc/") -1 + DECIMAL_STR_MAX(pid_t) + 1 + sizeof(field)); \
+                sprintf(_r_, "/proc/%lu/" field, (unsigned long) _pid_); \
+                _r_;                                                    \
+        })
-- 
1.8.2.1

