#
# Description: Honor users settings with lockout applet
# Forwarded: No ( Review in progress )
# Bug: 56389
# Author: nlecureuil@mandriva.com


Index: plasma/generic/applets/lock_logout/lockout.cpp
===================================================================
--- plasma/generic/applets/lock_logout/lockout.cpp	(revision 1118914)
+++ plasma/generic/applets/lock_logout/lockout.cpp	(working copy)
@@ -33,6 +33,7 @@
 // KDE
 #include <KIcon>
 #include <KJob>
+#include <KAuthorized>
 #ifndef Q_OS_WIN
 #include <KConfigDialog>
 #include <KSharedConfig>
@@ -208,10 +209,41 @@
 
 void LockOut::clickLogout()
 {
+    if (!KAuthorized::authorizeKAction("logout")) {
+        return;
+    }
+
     kDebug()<<"LockOut:: logout clicked ";
 #ifndef Q_OS_WIN
-    KWorkSpace::requestShutDown( KWorkSpace::ShutdownConfirmYes,
-                                 KWorkSpace::ShutdownTypeDefault,
+    KConfig config("ksmserverrc");
+    KConfigGroup cfg ;
+    cfg = KConfigGroup(&config, "General");
+ 
+    bool logoutConfirmed = cfg.readEntry( "confirmLogout", true );
+
+    KWorkSpace::ShutdownConfirm confirm = logoutConfirmed ?
+        KWorkSpace::ShutdownConfirmYes :
+        KWorkSpace::ShutdownConfirmNo ;
+
+    int logoutType = cfg.readEntry( "shutdownType", -1 );
+    KWorkSpace::ShutdownType Type;
+    switch (logoutType) {
+        case -1 :
+            Type = KWorkSpace::ShutdownTypeDefault;
+	case 0 :
+	    Type = KWorkSpace::ShutdownTypeNone;
+	case 1 :
+	    Type = KWorkSpace::ShutdownTypeReboot;
+	case 2 :
+	    Type = KWorkSpace::ShutdownTypeHalt;
+	case 3 :
+	    Type = KWorkSpace::ShutdownTypeLogout;
+	default:
+	    Type = KWorkSpace::ShutdownTypeDefault;
+    }
+
+    KWorkSpace::requestShutDown( confirm,
+                                 Type,
                                  KWorkSpace::ShutdownModeDefault);
 #endif
 }
Index: plasma/generic/containmentactions/contextmenu/menu.cpp
===================================================================
--- plasma/generic/containmentactions/contextmenu/menu.cpp	(revision 1118914)
+++ plasma/generic/containmentactions/contextmenu/menu.cpp	(working copy)
@@ -249,9 +249,36 @@
         return;
     }
 #ifndef Q_WS_WIN
-    KWorkSpace::requestShutDown(KWorkSpace::ShutdownConfirmYes,
-                                KWorkSpace::ShutdownTypeDefault,
-                                KWorkSpace::ShutdownModeDefault);
+    KConfig config("ksmserverrc");
+    KConfigGroup cfg ;
+    cfg = KConfigGroup(&config, "General");
+
+    bool logoutConfirmed = cfg.readEntry( "confirmLogout", true );
+
+    KWorkSpace::ShutdownConfirm confirm = logoutConfirmed ?
+        KWorkSpace::ShutdownConfirmYes :
+        KWorkSpace::ShutdownConfirmNo ;
+
+    int logoutType = cfg.readEntry( "shutdownType", -1 );
+    KWorkSpace::ShutdownType Type;
+    switch (logoutType) {
+        case -1 :
+            Type = KWorkSpace::ShutdownTypeDefault;
+       case 0 :
+           Type = KWorkSpace::ShutdownTypeNone;
+       case 1 :
+           Type = KWorkSpace::ShutdownTypeReboot;
+       case 2 :
+           Type = KWorkSpace::ShutdownTypeHalt;
+       case 3 :
+           Type = KWorkSpace::ShutdownTypeLogout;
+       default:
+           Type = KWorkSpace::ShutdownTypeDefault;
+    }
+
+    KWorkSpace::requestShutDown( confirm,
+                                 Type,
+                                 KWorkSpace::ShutdownModeDefault);
 #endif
 }
 
